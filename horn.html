<!DOCTYPE html>
<html lang="ja">
<meta charset="UTF-8">
<title>音源テスト</title>
<body style="font-family:system-ui;padding:16px">
  <h1>音源テスト</h1>

  <!-- 1) ブラウザ標準コントロール -->
  <p>① 直接再生（コントロール付き）</p>
  <audio id="a1" controls preload="auto">
    <!-- m4a優先 + mp3フォールバック -->
    <source src="./oudio/stock.m4a" type="audio/mp4"> 
    <source src="./oudio/stock.mp3" type="audio/mpeg">
    このブラウザは audio に対応していません
  </audio>

  <hr>

  <!-- 2) クリック再生（自動再生制限対策） -->
  <p>② ボタンで再生（クリック必須）</p>
  <button id="play">▶ 再生</button>
  <button id="stop">⏹ 停止</button>

  <script>
    const el = document.getElementById('a1');
    const playBtn = document.getElementById('play');
    const stopBtn = document.getElementById('stop');

    // クリックで確実にユーザー操作を作る
    playBtn.addEventListener('click', async () => {
      try {
        el.currentTime = 0;
        el.volume = 0.8;
        await el.play();
        console.log('play() success');
      } catch (e) {
        console.error('play() error:', e);
        alert('再生に失敗。まずはこのページ内のどこかをクリックしてから、もう一度試してください。');
      }
    });

    stopBtn.addEventListener('click', () => {
      el.pause();
      el.currentTime = 0;
    });

    // エラーの中身を拾う（原因特定に重要）
    el.addEventListener('error', () => {
      const m = el.error?.message || '';
      const code = el.error?.code;
      console.error('audio error code:', code, m);
      // codeの目安: 1=MEDIA_ERR_ABORTED, 2=NETWORK, 3=DECODE, 4=SRC_NOT_SUPPORTED
      alert('audioエラー: code=' + code + '（コンソールも見てね）');
    });

    // ブラウザがm4a/mp3を再生できるかの事前チェック
    console.log('canPlayType m4a:', el.canPlayType('audio/mp4'));
    console.log('canPlayType mp3:', el.canPlayType('audio/mpeg'));
  </script>
</body>
</html>
