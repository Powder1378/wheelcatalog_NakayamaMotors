<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ã‚¯ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è©¦è´</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>ã‚¯ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è©¦è´</h1>
    <nav>
      <a href="index.html">ğŸ  ãƒ›ã‚¤ãƒ¼ãƒ«ã‚«ã‚¿ãƒ­ã‚°</a>
      <a href="staff.html">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ç´¹ä»‹</a>
      <a href="horn.html">ğŸ”Š ã‚¯ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è©¦è´</a>
    </nav>

    <div id="horn-toolbar">
      <label>éŸ³é‡ <input id="horn-volume" type="range" min="0" max="1" step="0.01" value="0.7"></label>
      <button id="horn-stop" class="btn">â¹ åœæ­¢</button>
    </div>
  </header>

  <!-- æ³¢ç´‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ -->
  <canvas id="bg-ripples" aria-hidden="true"></canvas>

  <main id="horn-container"></main>

  
<script>
  // 1) ãƒ‡ãƒ¼ã‚¿
  const HORNS = [
    { id:"horn01", name:"ã‚¯ãƒ©ã‚¯ã‚·ãƒ§ãƒ³01", file:"./oudio/stock.m4a", comment:"çŸ­ãé‹­ã„" },
    { id:"horn02", name:"ã‚¯ãƒ©ã‚¯ã‚·ãƒ§ãƒ³02", file:"./oudio/truck.m4a", comment:"ä½ãé‡åš" },
    { id:"horn03", name:"ã‚¯ãƒ©ã‚¯ã‚·ãƒ§ãƒ³03", file:"./oudio/cop.m4a", comment:"è»½å¿«ãƒãƒƒãƒ—" },
  ];

  // 2) å…±æœ‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  const player = new Audio();
  player.preload = "auto";
  player.volume = 0.7;
  let currentId = null;

  const container = document.getElementById("horn-container");
  const volume    = document.getElementById("horn-volume");
  const stopBtn   = document.getElementById("horn-stop");

  volume.addEventListener("input", () => { player.volume = Number(volume.value); });
  stopBtn.addEventListener("click", () => { player.pause(); player.currentTime = 0; currentId = null; syncButtons(); });

  // 3) ã‚«ãƒ¼ãƒ‰æç”»
  function render(){
    container.innerHTML = "";
    HORNS.forEach(h=>{
      const card = document.createElement("div");
      card.className = "horn-card";
      card.innerHTML = `
        <h3>${h.name}</h3>
        <p class="horn-comment">${h.comment ?? ""}</p>
        <button class="play-btn" data-id="${h.id}">â–¶ å†ç”Ÿ</button>
      `;
      container.appendChild(card);
    });
    container.querySelectorAll(".play-btn").forEach(btn=>{
      btn.addEventListener("click", onPlayClick);
    });
  }

  // 4) å†ç”Ÿã‚¯ãƒªãƒƒã‚¯
  async function onPlayClick(e){
    try {
      const id = e.currentTarget.dataset.id;
      const horn = HORNS.find(x => x.id === id);
      if(!horn) return;

      // åˆå›ã‚¯ãƒªãƒƒã‚¯ã§å¿…ãšã‚ªãƒ¼ãƒ‡ã‚£ã‚ªç’°å¢ƒã‚’æº–å‚™ï¼ˆiOS/Safariå¯¾ç­–ï¼‰
      await ensureAudioContext();

      // åŒã˜ãƒœã‚¿ãƒ³ãªã‚‰åœæ­¢ãƒˆã‚°ãƒ«
      if (currentId === id && !player.paused) {
        player.pause();
        currentId = null;
        return syncButtons();
      }

      player.src = horn.file;
      currentId = id;

      // ã“ã“ã§æ³¢ç´‹åˆæœŸåŒ– â†’ ã™ãå†ç”Ÿ
      initAudioReactiveOnce();
      await player.play();

      syncButtons();
    } catch (err) {
      console.error("play() error:", err);
      alert("å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚éŸ³æºãƒ‘ã‚¹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿåˆ¶é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  }

  function syncButtons(){
    document.querySelectorAll(".play-btn").forEach(btn=>{
      const active = (btn.dataset.id===currentId && !player.paused);
      btn.textContent = active ? "â¸ åœæ­¢" : "â–¶ å†ç”Ÿ";
    });
  }

  // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯/ãƒ‘ã‚¹ã®ã‚¨ãƒ©ãƒ¼ã‚’æŠŠæ¡
  player.addEventListener("error", ()=>{
    console.error("audio error code:", player.error?.code); // 4=SRC_NOT_SUPPORTED, 3=DECODE
    alert("éŸ³æºã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ‘ã‚¹/æ‹¡å¼µå­/ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã‚’ç¢ºèªï¼‰");
  });
  player.addEventListener("ended", ()=>{ currentId = null; syncButtons(); });
  player.addEventListener("pause", ()=>{ if(player.currentTime===0){ currentId=null; syncButtons(); }});

  // 5) æ³¢ç´‹ï¼ˆéŸ³ã«åå¿œï¼‰
  let audioCtx, analyser, srcNode, rafId;
  let ripples = [];
  const canvas = document.getElementById("bg-ripples");
  const ctx = canvas.getContext("2d");

  function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener("resize", resizeCanvas); resizeCanvas();

  async function ensureAudioContext(){
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === "suspended") {
      // å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸­ã« resume ã™ã‚‹
      await audioCtx.resume();
    }
  }

  function initAudioReactiveOnce(){
    if (analyser) return; // äºŒé‡åˆæœŸåŒ–é˜²æ­¢
    if (!audioCtx) return; // ensureAudioContext ãŒå…ˆ
    srcNode = audioCtx.createMediaElementSource(player);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    srcNode.connect(analyser);
    // MediaElementã¯è‡ªåˆ†ã§å‡ºåŠ›ã™ã‚‹ã®ã§ destination ã«ã¯ç¹‹ãŒãªã„ï¼ˆé‡è¤‡å†ç”Ÿå›é¿ï¼‰
    startVisual();
  }

  function startVisual(){
    const buf = new Uint8Array(analyser.frequencyBinCount);
    cancelAnimationFrame(rafId);
    const loop = ()=>{
      rafId = requestAnimationFrame(loop);
      analyser.getByteTimeDomainData(buf);

      // éŸ³é‡ã®ç›®å®‰ï¼ˆRMSï¼‰
      let sum=0;
      for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
      const rms = Math.sqrt(sum/buf.length);

      // ã—ãã„å€¤è¶…ãˆã§æ³¢ç´‹è¿½åŠ 
      if (rms > 0.05) spawnRipple(rms);

      drawRipples();
    };
    loop();
  }

  function spawnRipple(power){
    const x = canvas.width/2  + (Math.random()-0.5)*200;
    const y = canvas.height/2 + (Math.random()-0.5)*100;
    ripples.push({
      x, y, r: 0,
      maxR: Math.min(canvas.width, canvas.height) * (0.25 + power*0.5),
      alpha: 0.7,
      line: 2 + power*8
    });
    if (ripples.length > 50) ripples.shift();
  }

  function drawRipples(){
    // å‰ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ï¼ˆç”»é¢ãŒç™½ã£ã½ããªã‚‰ãªã„ï¼‰
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ripples.forEach(r=>{
      r.r += 3;
      r.alpha *= 0.96;
      ctx.beginPath();
      ctx.arc(r.x, r.y, r.r, 0, Math.PI*2);
      ctx.strokeStyle = `rgba(2,136,209,${r.alpha})`;
      ctx.lineWidth = r.line;
      ctx.stroke();
    });

    ripples = ripples.filter(r => r.alpha > 0.02 && r.r < r.maxR);
  }

  // åˆæœŸæç”»
  render();
</script>
